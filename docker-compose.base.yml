# Base Docker Compose - Shared configuration for all environments
# Usage:
#   Dev: docker-compose -f docker-compose.base.yml -f docker-compose.dev.yml up
#   Prod: docker-compose -f docker-compose.base.yml -f docker-compose.prod.yml up

services:
    nestjs:
        image: johannesschaefer/nestjs:${TAG:-dev}
        container_name: nestjs
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - app-network
            - monitoring
        labels:
            logging: "promtail"
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "10"
                compress: "true"
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:3000/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    mongodb:
        image: johannesschaefer/mongo:${TAG:-dev}
        container_name: mongodb
        volumes:
            - mongodb_data:/data/db/
            - mongodb_log:/var/log/mongodb/
        networks:
            - app-network
            - monitoring
        labels:
            logging: "promtail"
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "10"
                compress: "true"
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    nginx:
        image: johannesschaefer/nginx:${TAG:-dev}
        container_name: nginx
        depends_on:
            nestjs:
                condition: service_healthy
        networks:
            - app-network
            - monitoring
        labels:
            logging: "promtail"
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "10"
                compress: "true"
        healthcheck:
            test:
                [
                    "CMD",
                    "wget",
                    "--quiet",
                    "--tries=1",
                    "--spider",
                    "http://localhost:80/health",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 20s

    mongodb-exporter:
        image: percona/mongodb_exporter:0.47.1
        container_name: mongodb-exporter
        ports:
            - "9216:9216"
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "10"
                compress: "true"
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - app-network
            - monitoring

volumes:
    mongodb_data:
    mongodb_log:

networks:
    app-network:
        driver: bridge
    monitoring:
        external: true
        name: monitoring
